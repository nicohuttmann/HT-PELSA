---
title: "staurosporine_dose_response"
author: "kejia"
date: "2025-04-13"
output:
  html_document:
    keep_md: true
    toc: true
    theme: united
    toc_float: true
    code_folding: hide
  pdf_document:
    toc: true
editor_options:
  
  chunk_output_type: console
---

# 1.General settings 
## 1.1 Chunk settings
```{r setup}

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  include = TRUE,
  cache = TRUE,
  cache.lazy = FALSE,
  eval = TRUE,
  fig.width = 4 * (1 + sqrt(5)) / 2, 
  fig.height = 4,
  dpi = 700)

```

## 1.2 Packages

```{r, message=F, warning =F}

library(progress)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(knitr)
library(ggpubr)
library(ggforce)
library(UniprotR)
library(Peptides)
library(biomaRt)
library(Biostrings)
library(limma)
library(vroom)
library(stringr)
library(corrplot)
library(drc)
library(openxlsx)
library(ggh4x)
library(data.table)

mutate <- dplyr::mutate
select <- dplyr::select
group_by <- dplyr::group_by
filter <- dplyr::filter
rename <- dplyr::rename

```

## 1.3 Graphics

```{r}

mytheme <- theme( 
  panel.background = element_rect(color = "black",size=0.5),
  axis.title = element_text(colour="black",size=7),
  axis.text  = element_text(size=7,color="black"),
  plot.title = element_text(size=8,color="black"),
  text = element_text(size = 7),
  axis.line = element_line(linewidth = 0.4),
  axis.ticks  = element_line(linewidth = 0.4),
  legend.position = "top",legend.key.size = unit(0.35,"cm"),
  legend.text =element_text(colour = "black",size=7),panel.border = element_blank()
)

```

# 2. Import raw data
```{r}

data_dd <- 
  vroom::vroom("staurosporine_dd_report.pr_matrix.tsv") 

colnames(data_dd)

# simplify the colnames
colnames_subset <- colnames(data_dd)[11:42]
common_prefix <- "S:\\01_users\\Kejia\\Experiments\\20250210_stau_DD_astral\\250213_Astral_S0000_CP_LKJ_PELSA_RT_4min_4pc_2mz_430-670_3000AGC_Stauro_"
common_prefix <- gsub("\\\\", "\\\\\\\\", common_prefix)
common_suffix <- ".raw"
simplified_colnames <- sub(common_prefix, "", colnames_subset)
simplified_colnames <- sub(paste0(common_suffix, "$"), "", simplified_colnames)  # 
colnames(data_dd)[11:42] <- simplified_colnames
colnames(data_dd)[40] <- "200nM_R2"

```



# 3 From precursor to peptide

## 3.1 Calculate peptide-level intensity
```{r}

peptide_dd <- data_dd %>%
  group_by(Stripped.Sequence) %>%
  mutate(across(c("0nM_R1":"200nM_R4"), ~sum(.x, na.rm = TRUE), .names = "sum_{col}")) %>% distinct(Stripped.Sequence, .keep_all = TRUE) %>%
  ungroup() 

```

## 3.2 Annotate peptide with location

```{r}

diann_prec_add_peptide_pos2 <- function(data_precursor, fasta, silent = T) {
  
  if (!hasArg(data_precursor)) stop("Please specify a data frame or a tibble of the DIA-NN precursors.")
  
  if (!hasArg(fasta)) fasta <- choose.files(multi = F, )
  fasta <- Biostrings::readAAStringSet(fasta)
  fasta <- as.character(fasta)
  names(fasta) <- unlist(lapply(strsplit(x = names(fasta), "\\|"), \(x) x[2]))
  
  if (!silent) {
    message(paste0(nrow(data_precursor), " precursors identified. This should take around ", 
                   round(nrow(data_precursor) * 0.0000884 + 0.1463016, 2), " s."))
    t0 <- Sys.time()
  }
  
  # Add peptide positions
  data_pos <- data_precursor %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(peptide.length = nchar(Stripped.Sequence), 
                  from = regexpr(Stripped.Sequence, as.character(fasta[unlist(strsplit(Protein.Group, ";"))[1]]))[1], 
                  to = from + peptide.length - 1, 
                  .after = Modified.Sequence) %>% 
    dplyr::ungroup()
  
  if (!silent) {
    t1 <- Sys.time()
    
    duration <- t1 - t0
    
    if (duration > nrow(data_precursor) * 0.0000884 + 0.1463016) {
      message(paste0("Sorry for the delay! It took ", round(duration, 2), " s."))
    } else {
      message(paste0("Wow, even faster! It only took ", round(duration, 2), " s."))
    }
  }
  
  return(data_pos)
  
}


# Input the imported precursor data frame and specify the fasta file
peptide_dd_with_position <- diann_prec_add_peptide_pos2(data_precursor = peptide_dd, fasta = "UP000005640_HomoSapiens_ID9606_20594entries_26102022_dl11012023.fasta", silent = F)

save(peptide_dd_with_position, file = "peptide_dd_with_position.Rdata")


```


## 3.3 Extract different replicates

```{r}

peptide_replicates <- lapply(paste0("R", 1:4), function(rep_id) {
  peptide_dd_with_position %>%
    select(1:11, contains("sum") & contains(rep_id)) %>%
    filter(rowSums(across(12:19, ~ .x == 0)) == 0)
})

names(peptide_replicates) <- paste0("peptide_dd_rep", 1:4)

```

## 3.4 visualize data completeness

```{r}

peptide_dd_quantification_count <- peptide_dd_with_position %>%
  mutate(
    rep1 = ifelse(Stripped.Sequence %in% peptide_replicates[[1]]$Stripped.Sequence, 1, 0),  
    rep2 = ifelse(Stripped.Sequence %in% peptide_replicates[[2]]$Stripped.Sequence, 1, 0),  
    rep3 = ifelse(Stripped.Sequence %in% peptide_replicates[[3]]$Stripped.Sequence, 1, 0),  
    rep4 = ifelse(Stripped.Sequence %in% peptide_replicates[[4]]$Stripped.Sequence, 1, 0), 
    total_count = rep1 + rep2 + rep3 + rep4
  ) %>%
  select(1:10, 46:82)



peptide_dd_quantification_count$total_count <- as.factor(peptide_dd_quantification_count$total_count)

reps_count <- as.data.frame(table(peptide_dd_quantification_count$total_count))

colnames(reps_count) <- c("number_of_reps", "count")


ggplot(data=reps_count ,mapping=aes(x= number_of_reps, y=count)) + 
  geom_bar(stat = "identity",position = "dodge",color="black")+
  theme_classic()+
  geom_text(aes(label = count), vjust = -0.5, color = "black", size = 4) 

write.csv(file = "peptide_dd_with_position_count.csv", 
          peptide_dd_quantification_count)

```


## 3.5 calculate peptide affinity 

```{r}

# Only run this code if fitting data is not present (takes ~2 h per replicate)

if (!file.exists("export_dd_stau_peptide_stabilized_R1.csv")) {
  
  # Calculate log2FC和Ratio
  calculate_ratios <- function(data, rep) {
    for (i in c("0nM","02nM","2nM","20nM","200nM","2uM","20uM","100uM")) {
      data[, paste0("log2FC_", i, "_0nM_", rep)] <- log2(data[, paste0("sum_", i, "_", rep)] / data[, paste0("sum_0nM_", rep)])
      data[, paste0("Ratio_", i, "_0nM_", rep)] <- data[, paste0("sum_", i, "_", rep)] / data[, paste0("sum_0nM_", rep)]
    }
    return(data)
  }
  
  peptide_dd_rep1 <- calculate_ratios(peptide_replicates[[1]], "R1")
  peptide_dd_rep2 <- calculate_ratios(peptide_replicates[[2]], "R2")
  peptide_dd_rep3 <- calculate_ratios(peptide_replicates[[3]], "R3")
  peptide_dd_rep4 <- calculate_ratios(peptide_replicates[[4]], "R4")
  
  
  
  # From here, change the imported data for different replicates
  
  ## pre-filter peptides (stabilized) 
  subset_target <- peptide_dd_rep1 %>%
    filter(Ratio_100uM_0nM_R1 < 0.7 & Ratio_20uM_0nM_R1 < 1) %>%
    select(Stripped.Sequence,Genes,First.Protein.Description,Protein.Ids,contains("Ratio"))%>% gather(concentration,Ratio,paste0("Ratio_","0nM","_0nM_R1"):paste0("Ratio_","100uM","_0nM_R1")) 
  
  ## pre-filter peptides (destabilized)
  # subset_target <- peptide_dd_rep1 %>%
  #   filter(Ratio_100uM_0nM_R1 > 1.3 & Ratio_20uM_0nM_R1 > 1) %>%
  #   select(Stripped.Sequence,Genes,First.Protein.Description,Protein.Ids,contains("Ratio"))%>% gather(concentration,Ratio,paste0("Ratio_","0nM","_0nM_R1"):paste0("Ratio_","100uM","_0nM_R1"))
  
  
  # fit the curve
  subset_target$EC50<-0
  subset_target$R2<-0
  subset_target$lower <- 0
  subset_target$upper <- 0
  EC50.col <- grep("EC50",colnames(subset_target))
  R2.col <- grep("R2",colnames(subset_target))
  lower.col <- grep("lower",colnames(subset_target))
  upper.col <- grep("upper",colnames(subset_target))
  
  data_peptide <- data.frame(conc = c(log10(1e-12), log10(2e-10), log10(2e-9), log10(2e-8), log10(2e-7), log10(2e-6), log10(2e-5), log10(1e-4)), ratio = subset_target$Ratio)
  
  
  pb <- progress_bar$new(
    format = "[:bar] :percent :elapsed", 
    total = length(subset_target$Stripped.Sequence), 
    clear = FALSE, 
    width = 60 
  )
  
  state <- c(0)
  for (peptide in subset_target$Stripped.Sequence) {
    pb$tick()
    state <- state + 1
    #*****
    data_peptide <- data.frame(conc = c(log10(0), log10(2e-10), log10(2e-9), log10(2e-8), log10(2e-7), log10(2e-6), log10(2e-5), log10(1e-4)), ratio = subset_target[subset_target$Stripped.Sequence == peptide, ]$Ratio)
    
    peptide_drm <- tryCatch(
      drm(ratio~conc,data=data_peptide,fct = LL.4(),logDose = 10),
      error=function(e){ print("Correlation LL.4 failed");return(NA)}
    )
    
    
    # export PEC50
    subset_target[state,EC50.col] <- tryCatch(
      round(-log(coef(peptide_drm)[[4]],base =10),digits = 4),
      error=function(e){return(NA)}
    )
    
    # export lower
    subset_target[state,lower.col] <- tryCatch(
      as.numeric(coef(peptide_drm)[2]),
      error=function(e){return(NA)}
    )
    
    # export upper
    subset_target[state,upper.col] <- tryCatch(
      as.numeric(coef(peptide_drm)[3]),
      error=function(e){return(NA)}
    )
    
    
    # export R
    subset_target[state,R2.col] <- tryCatch(
      round((cor(data_peptide$ratio, fitted(peptide_drm), method = "pearson"))^2,digits = 4),
      error=function(e){return(NA)}
    )
    
  }
  
  stabilized_peptides <- subset_target %>%
    pivot_wider(names_from = concentration, values_from = Ratio)
  class(stabilized_peptides)
  
  # output
  write.csv (file = paste0("export_dd_stau_peptide_stabilized_R1",".csv"), 
             stabilized_peptides, row.names = F)
  
}


```



# 4 Combine affinity data

## 4.1 affinity data import

```{r}

affinity_rep1 <- 
  bind_rows(
    "stabilized" =  read.csv("export_dd_stau_peptide_stabilized_R1.csv"),
    "destabilized" = read.csv("export_dd_stau_peptide_destabilized_R1.csv"),
    .id ="type") %>%
  filter(R2 >0.9) %>%
  rename(EC50_rep1= EC50, R2_rep1=R2,lower_rep1 = lower, upper_rep1=upper)


affinity_rep2 <- 
  bind_rows(
    "stabilized" =  read.csv("export_dd_stau_peptide_stabilized_R2.csv"),
    "destabilized" = read.csv("export_dd_stau_peptide_destabilized_R2.csv"),
    .id ="type") %>%
  filter(R2 >0.9) %>%
  rename(EC50_rep2= EC50, R2_rep2=R2,lower_rep2 = lower, upper_rep2=upper)


affinity_rep3 <- 
  bind_rows(
    "stabilized" =  read.csv("export_dd_stau_peptide_stabilized_R3.csv"),
    "destabilized" = read.csv("export_dd_stau_peptide_destabilized_R3.csv"),
    .id ="type") %>%
  filter(R2 >0.9) %>%
  rename(EC50_rep3= EC50, R2_rep3=R2,lower_rep3 = lower, upper_rep3=upper)


affinity_rep4 <- 
  bind_rows(
    "stabilized" =  read.csv("export_dd_stau_peptide_stabilized_R4.csv"),
    "destabilized" = read.csv("export_dd_stau_peptide_destabilized_R4.csv"),
    .id ="type") %>%
  filter(R2 >0.9) %>%
  rename(EC50_rep4= EC50, R2_rep4=R2,lower_rep4 = lower, upper_rep4=upper)


```


## 4.2 add affinities to each peptide
```{r}

# put affinity_rep in the list
affinity_reps <- list(affinity_rep1, affinity_rep2, affinity_rep3, affinity_rep4)


sta_list <- lapply(affinity_reps, function(x) filter(x, type == "stabilized"))
desta_list <- lapply(affinity_reps, function(x) filter(x, type == "destabilized"))


peptide_dd_affinity_count <- peptide_dd_quantification_count %>%
  mutate(
    # stabilized counts
    rep1_sta_dd = ifelse(Stripped.Sequence %in% sta_list[[1]]$Stripped.Sequence, 1, 0),
    rep2_sta_dd = ifelse(Stripped.Sequence %in% sta_list[[2]]$Stripped.Sequence, 1, 0),
    rep3_sta_dd = ifelse(Stripped.Sequence %in% sta_list[[3]]$Stripped.Sequence, 1, 0),
    rep4_sta_dd = ifelse(Stripped.Sequence %in% sta_list[[4]]$Stripped.Sequence, 1, 0),
    total_dd_count_sta = rep1_sta_dd +rep2_sta_dd+ rep3_sta_dd +rep4_sta_dd,
    
    # destabilized counts
    rep1_des_dd = ifelse(Stripped.Sequence %in% desta_list[[1]]$Stripped.Sequence, 1, 0),
    rep2_des_dd = ifelse(Stripped.Sequence %in% desta_list[[2]]$Stripped.Sequence, 1, 0),
    rep3_des_dd = ifelse(Stripped.Sequence %in% desta_list[[3]]$Stripped.Sequence, 1, 0),
    rep4_des_dd = ifelse(Stripped.Sequence %in% desta_list[[4]]$Stripped.Sequence, 1, 0),
    total_dd_count_des = rep1_des_dd +rep2_des_dd+ rep3_des_dd + rep4_des_dd)  %>%
  mutate(across(c(total_dd_count_sta, total_dd_count_des),as.factor))  %>%
  mutate(regulation = 
           case_when(
             as.numeric(as.character(total_dd_count_des)) >2 ~"destabilized",
             as.numeric(as.character(
               total_dd_count_sta)) > 2 ~"stabilized",
             as.numeric(as.character(
               total_count)) <3 ~"underquantified",
             as.numeric(as.character(
               total_count)) >2 ~"unresponsive",
             TRUE~"unknown"))


## visualize how many peptides are stabilized or destabilized in how many replicates

reps_count <- as.data.frame(table(peptide_dd_affinity_count$total_dd_count_sta))
colnames(reps_count) <- c("number_of_reps", "count")

ggplot(data=reps_count ,mapping=aes(x= number_of_reps, y=count))+geom_bar(stat = "identity",position = "dodge",color="black")+
  theme_classic()+
  geom_text(aes(label = count), vjust = -0.5, color = "black", size = 4) 





combine <- peptide_dd_affinity_count %>%
  left_join(sta_list[[1]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids"))%>%
  left_join(sta_list[[2]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids"))%>%
  left_join(sta_list[[3]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids"))%>%
  left_join(sta_list[[4]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids")) %>%   left_join(desta_list[[1]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids"))%>%
  left_join(desta_list[[2]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids"))%>%
  left_join(desta_list[[3]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids"))%>%
  left_join(desta_list[[4]],by=c("Stripped.Sequence","Genes","First.Protein.Description","Protein.Ids")) %>%
  select(-contains("type"))




colnames_all <- names(combine[c(59:154)])
dupe_prefixes <- unique(gsub("\\.(x|y)$", "", colnames_all))

for (col in dupe_prefixes) {
  col_x <- paste0(col, ".x")
  col_y <- paste0(col, ".y")
  
  combine[[col]] <- coalesce(combine[[col_x]], combine[[col_y]])
  
  combine[[col_x]] <- NULL
  combine[[col_y]] <- NULL
}


calculate_cv_all <- function(x) {
  valid_values <- na.omit(x)
  (sd(valid_values) / mean(valid_values))}


final_list <- combine %>%
  mutate(CV_EC50 = NA_real_,
         mean_EC50 = NA_real_,
         CV_EC50 = ifelse(regulation %in% c("stabilized", "destabilized"),
                          apply(select(., starts_with("EC50_")), 1, calculate_cv_all),
                          CV_EC50),
         
         mean_EC50 = ifelse(regulation %in% c("stabilized", "destabilized"),
                            rowMeans(across(starts_with("EC50_rep")), na.rm = TRUE),
                            mean_EC50),
         is.kinase = case_when(
           grepl("kinase", First.Protein.Description, ignore.case = TRUE) ~ "yes",
           is.na(First.Protein.Description) ~ NA_character_,
           TRUE ~ "no"))



write.csv(final_list, file = "Supplementary Dataset2.csv")

```

# 5 Plot

## Fig.1C: Dose-response curves of GAK

```{r}

## data preparation
sta <- final_list %>%
  filter(total_dd_count_sta == 4) %>% 
  select(1:10,109,contains("Ratio"), contains("EC50_"))%>%
  rename_with(~ gsub("rep", "R", .x), matches("rep")) %>%
  pivot_longer(
    cols = contains("Ratio") | contains("EC50"),  
    names_to = "Full_Name",                      
    values_to = "Value"                         
  ) %>%
  separate(
    Full_Name,                                   
    into = c("Type", "Replicate"),               
    sep = "_(?=[^_]*R\\d+$)",                    
    convert = TRUE                               
  ) %>%
  pivot_wider(
    names_from = Type,                          
    values_from = Value                         
  ) %>%
  pivot_longer(
    cols = contains("Ratio"),  
    names_to = "Concentrations",                 
    values_to = "Ratio" )%>%
  mutate(
    concentration_num = case_when(
      Concentrations == "Ratio_0nM_0nM" ~ log10(1e-11),
      Concentrations == "Ratio_02nM_0nM" ~ log10(2e-10),
      Concentrations == "Ratio_2nM_0nM" ~ log10(2e-9),
      Concentrations == "Ratio_20nM_0nM" ~ log10(2e-8),
      Concentrations == "Ratio_200nM_0nM" ~ log10(2e-7),
      Concentrations == "Ratio_2uM_0nM" ~ log10(2e-6),
      Concentrations == "Ratio_20uM_0nM" ~ log10(2e-5),
      Concentrations == "Ratio_100uM_0nM" ~ log10(1e-4),
      TRUE ~ NA_real_  
    )
  ) 



color_palette <- c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728","#9467bd", "#8c564b", "#e377c2","#b3b3b3")


protein <- "GAK"

test <- sta %>%
  filter(Genes== protein) %>%
  na.omit() %>%
  group_by(Stripped.Sequence, concentration_num) %>%
  summarise(
    mean_Ratio = mean(Ratio, na.rm = TRUE),
    sd_Ratio = sd(Ratio, na.rm = TRUE),       
    n = n(),                                 
    sem_Ratio = sd_Ratio / sqrt(n)            
  ) %>%
  ungroup()                             


## Plotting

p <- ggplot(test, aes(x = concentration_num, y = mean_Ratio, color = Stripped.Sequence)) +
  geom_point(size = 1, alpha = 0.8) +
  geom_errorbar(
    aes(
      ymin = mean_Ratio - sd_Ratio, 
      ymax = mean_Ratio + sd_Ratio),
    width = 0.3,                    
    size = 0.5,
    alpha = 0.6
  ) +geom_smooth(
    method = "drm",
    method.args = list(fct = LL.4(), logDose = 10),
    se = FALSE,                    
    size = 0.5
  ) +
  labs(
    x = "Log10(conc/M)",
    y = "Ratio",
    title = "peptides of GAK",
    color = "Peptide"
  ) +
  scale_x_continuous(breaks = seq(-13, -2)) +
  scale_y_continuous(
    limits = c(0, 1.3),
    breaks = seq(0, 1.3, 0.3)
  ) +
  scale_color_manual(values = color_palette)+
  theme_bw() + 
  theme(
    panel.grid = element_blank(),
    legend.position = "right"
  ) +force_panelsizes(rows = unit(1.1, "in"), cols = unit(1.1, "in"))
p

ggsave("Fig1C.pdf", plot = p,
       width = 6,          
       height = 4,        
       bg = "white")      

```


## Fig.1D: CV distribution of pEC50
```{r}

stabilized_peptides <- final_list %>%
  filter(total_dd_count_sta == 3 | total_dd_count_sta == 4)


median_val <- median(stabilized_peptides$CV_EC50, na.rm = TRUE)

p <- ggplot(stabilized_peptides, aes(x = CV_EC50)) +
  geom_density(fill = "#a995c4", alpha = 0.5, color = "black",size = 0.4)+
  geom_vline(xintercept = median_val, color = "#999999", linetype = "dashed", linewidth = 0.3) +  
  annotate(
    "text", 
    size=3,
    x = median_val, 
    y = 0.1 * max(density(stabilized_peptides$CV_EC50, na.rm = TRUE)$y),
    label = paste("Median =", round(median_val, 2)),
    color = "red", vjust = -1, hjust = -0.1
  ) +
  labs(
    title = "CV of pEC50 for stabilized peptides",
    x = "CV of pEC50 across replicates",
    y = "Density"
  ) + 
  annotate("text", 
           x = max(stabilized_peptides$CV_EC50, na.rm = TRUE) ,
           y = Inf,
           label = paste("Total destabilized peptides n =", nrow(stabilized_peptides)),
           vjust = 1.5, hjust = 1,
           size = 2.4, color = "black")+
  force_panelsizes(rows = unit(1.85, "in"),
                   cols = unit(1.85, "in"))+theme_classic()+mytheme

p

ggsave("Figure_1D.pdf",p,width =8,height = 8,units = "cm")

```


## Fig.1E: pEC50 distribution for the stabilized peptides (420)

```{r}

stabilized_peptides <- final_list %>%
  filter(total_dd_count_sta == 3 | total_dd_count_sta == 4)

group_counts <- stabilized_peptides %>%
  group_by(is.kinase) %>%
  summarise(count = n()) %>%
  mutate(label = paste0(is.kinase, " (n=", count, ")"))

p <- ggplot(data = stabilized_peptides, mapping = aes(x = mean_EC50, 
                                                      fill = factor(is.kinase, 
                                                                    levels = c("yes", "no")))) +
  geom_density(mapping = aes(y = after_stat(density * n/nrow(stabilized_peptides))), alpha = 0.6, size = 0.5) +
  theme_classic() +
  scale_fill_manual(
    name = "Is.kinase",
    values = c("#6baed6", "#7fc97f"),
    breaks = c("no", "yes"),
    labels = group_counts$label  
  ) +
  labs(
    x = "Mean pEC50",  
    y = "Density"         
  ) +
  force_panelsizes(rows = unit(1.85, "in"), cols = unit(1.85, "in")) +
  mytheme +
  annotate("text", 
           x = max(stabilized_peptides$mean_EC50, na.rm = TRUE) ,
           y = Inf,
           label = paste("Total stabilized proteins n =", nrow(stabilized_peptides)),
           vjust = 1.5, hjust = 1,
           size = 2.4, color = "black")

p

ggsave("Figure_1E.pdf", plot = p,
       width = 2.5,          
       height = 2.8,         
       dpi = 300,        
       bg = "white")  

```


## Fig.1F: pEC50 distribution for the destabilized peptides

```{r}

destabilized_peptides <- final_list %>%
  filter(total_dd_count_des == 3 | total_dd_count_des == 4)


group_counts <- destabilized_peptides %>%
  group_by(is.kinase) %>%
  summarise(count = n()) %>%
  mutate(label = paste0(is.kinase, " (n=", count, ")"))

p <- ggplot(data = destabilized_peptides, mapping = aes(x = mean_EC50, 
                                                        fill = factor(is.kinase, 
                                                                      levels = c("yes", "no")))) +
  geom_density(mapping = aes(y = after_stat(density * n/nrow(destabilized_peptides))), alpha = 0.6, size = 0.5) +
  theme_classic() +
  scale_fill_manual(
    name = "Is.kinase",
    values = c("#6baed6", "#7fc97f"),
    breaks = c("no", "yes"),
    labels = group_counts$label 
  ) +
  labs(
    x = "Mean pEC50",  
    y = "Density"          
  ) +
  force_panelsizes(rows = unit(1.85, "in"), cols = unit(1.85, "in")) +
  mytheme +
  annotate("text", 
           x = max(destabilized_peptides$mean_EC50, na.rm = TRUE) ,
           y = Inf,
           label = paste("Total destabilized proteins n =", nrow(destabilized_peptides)),
           vjust = 1.5, hjust = 1,
           size = 2.4, color = "black")

p

ggsave("Figure_1F.pdf", plot = p,
       width = 2.5,          
       height = 2.8,         
       dpi = 300,        
       bg = "white")  


```



## Fig.1G: Affinity correlation between HT-PELSA and kinobeads
```{r}

kinase_id <- read.csv("kinase_hub.csv", header = T)


pelsa_affinity <- final_list %>%
  filter(regulation %in% c("stabilized","destabilized")) %>% 
  rename("UniprotID"="Protein.Group") %>% 
  left_join(kinase_id,by= "UniprotID") %>%
  rename(kinase = 110) %>%
  filter(!is.na(kinase)) %>%
  arrange(desc(mean_EC50)) %>%
  distinct(UniprotID,.keep_all = TRUE) 

write.csv(file = "pelsa_affinity.csv",pelsa_affinity)

colnames(pelsa_affinity)

kinobeads <- read.csv("kinobeads_affinity.csv", header = T)


all <- pelsa_affinity %>%
  inner_join(kinobeads,by = "kinase") 

correlation <- cor(all$mean_EC50, all$pIC50, method  = "pearson")




p <- ggplot() +
  geom_point(data = all, aes(x = mean_EC50, y = pIC50,color = regulation)) +
  xlab("PELSA_pEC50")+ylab("kinobeads_pEC50")+
  annotate("text", x = min(all$mean_EC50), y = max(all$pIC50)*0.95, 
           label = paste("r =", round(correlation, 2)), 
           hjust = 0, vjust = 1, size = 5, color = "black") +
  scale_color_manual(values = c("stabilized" = "#7fc97f", "destabilized" = "#ba115b"))+
  annotate("text",
           x = min(all$mean_EC50),
           y = max(all$pIC50),  # 放在相关系数下方
           label = paste("n =", nrow(all)),
           hjust = 0, vjust = 1,
           size = 5, color = "black") +
  geom_smooth(
    data = all,  
    aes(x = mean_EC50, y = pIC50),
    method = "lm",
    se = TRUE,  
    color = "black",  
    fill = "#7fc97f",   
    alpha = 0.2,        
    linetype = "solid") + 
  theme(legend.position = "top")

p

ggsave(paste0("Fig1G",".pdf"),p,width = 4,height=4.3,dpi=300)

```

