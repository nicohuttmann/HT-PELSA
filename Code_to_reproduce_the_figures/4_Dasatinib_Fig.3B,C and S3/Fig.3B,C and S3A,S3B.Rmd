---
title: "HT-PELSA_Dasatinib"
author: "kejia"
date: "2025-02-21"
output:
  html_document:
    keep_md: true
    toc: true
    theme: united
    toc_float: true
    code_folding: hide
  pdf_document:
    toc: true
editor_options:
  
  chunk_output_type: console
---

# 1.General settings 
## 1.1 Chunk settings
```{r setup}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  include = TRUE,
  cache = TRUE,
  cache.lazy = FALSE,
  eval = TRUE,
  fig.width = 4 * (1 + sqrt(5)) / 2, 
  fig.height = 4,
  dpi = 700
)
```

## 1.2 Packages

```{r, message=F, warning =F}
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(knitr)
library(ggpubr)
library(ggforce)
library(UniprotR)
library(Peptides)
library(biomaRt)
library(Biostrings)
library(limma)
library(vroom)
library(stringr)
library(corrplot)
library(ggh4x)
library(openxlsx)

mutate <- dplyr::mutate
select <- dplyr::select
group_by <- dplyr::group_by
filter <- dplyr::filter
rename <- dplyr::rename

```

## 1.3 Graphics

```{r}

mytheme <- theme_minimal() +  
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5), 
    axis.title = element_text(size = 12),  
    axis.text = element_text(size = 12,color="black"),  
    legend.title = element_text(size = 12),  
    legend.text = element_text(size = 10),  
    panel.grid.major = element_line(color = "grey80", linewidth = 0.2), 
    panel.grid.minor = element_blank(), 
    panel.background = element_rect(fill = "white", color = "black", linewidth = 1), 
    plot.background = element_rect(fill = "white",colour = NA),axis.ticks = element_line(color = "black", linewidth = 0.5),  
    axis.ticks.length = unit(0.2, "cm"))

```

# 2. Import data

```{r}

crude <- vroom::vroom("dasatinib_crude_report.pr_matrix.tsv")
cleared <- vroom::vroom("dasatinib_supernatant_report.pr_matrix.tsv")

diann_prec_add_peptide_pos2 <- function(data_precursor, fasta, silent = T) {
  
  if (!hasArg(data_precursor)) stop("Please specify a data frame or a tibble of the DIA-NN precursors.")
  
  if (!hasArg(fasta)) fasta <- choose.files(multi = F, )
  fasta <- Biostrings::readAAStringSet(fasta)
  fasta <- as.character(fasta)
  names(fasta) <- unlist(lapply(strsplit(x = names(fasta), "\\|"), \(x) x[2]))
  
  if (!silent) {
    message(paste0(nrow(data_precursor), " precursors identified. This should take around ", 
                   round(nrow(data_precursor) * 0.0000884 + 0.1463016, 2), " s."))
    t0 <- Sys.time()
  }
  
  # Add peptide positions
  data_pos <- data_precursor %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(peptide.length = nchar(Stripped.Sequence), 
                  from = regexpr(Stripped.Sequence, as.character(fasta[unlist(strsplit(Protein.Group, ";"))[1]]))[1], 
                  to = from + peptide.length - 1, 
                  .after = Modified.Sequence) %>% 
    dplyr::ungroup()
  
  if (!silent) {
    t1 <- Sys.time()
    
    duration <- t1 - t0
    
    if (duration > nrow(data_precursor) * 0.0000884 + 0.1463016) {
      message(paste0("Sorry for the delay! It took ", round(duration, 2), " s."))
    } else {
      message(paste0("Wow, even faster! It only took ", round(duration, 2), " s."))
    }
  }
  
  return(data_pos)
  
}


# Input the imported precursor data frame and specify the fasta file
fasta_path <- "UP000005640_HomoSapiens_ID9606_20594entries_26102022_dl11012023.fasta"

Annotated_crude <- diann_prec_add_peptide_pos2(crude, fasta_path, F)
Annotated_cleared <- diann_prec_add_peptide_pos2(cleared, fasta_path, F)

```


# 3. Divide into two groups

```{r}

renamed_cleared <- Annotated_cleared %>%
  select(1:13,14,20,18,15,21,19,17,16) %>% 
    rename(
      control_1 = 14, control_2 = 15, control_3 = 16,
      control_4 = 17, drug_1 = 18, drug_2 = 19,
      drug_3 = 20, drug_4 = 21)
    
renamed_crude <- Annotated_crude %>%
  select(1:21) %>% 
    rename(
      control_1 = 14, control_2 = 15, control_3 = 16,
      control_4 = 17, drug_1 = 18, drug_2 = 19,
      drug_3 = 20, drug_4 = 21)
    

```



# 4. Statistic test analysis

```{r, include=FALSE,eval=FALSE}

analyze_data <- function(data, dataset_name) {
  
  
  # step-1：data-processing
  peptide_intensity <- data %>%
    group_by(Stripped.Sequence) %>%
    select(1:13,18:21,14:17) %>% 
    mutate(across(c(drug_1, drug_2, drug_3, drug_4, control_1, control_2, control_3, control_4), ~sum(.x, na.rm = TRUE), .names = "sum_{col}")) %>%
    select(Protein.Ids, Genes, First.Protein.Description, Stripped.Sequence, peptide.length, from, to, 
           starts_with("sum_")) %>%
    distinct(Stripped.Sequence, .keep_all = TRUE) %>%
    ungroup() %>%
    filter(rowSums(.[8:15] == 0) == 0)
  
  
  # step-2：Bayes t-test
  data <- peptide_intensity %>% select(c(1:7, 12:15, 8:11))
  columnnames <- c("Protein.Ids", "Genes", "name", "sequence", "length", "start", "end", 
                   "control_1", "control_2", "control_3", "control_4", "D1_1", "D1_2", "D1_3", "D1_4", "UID")
  design <- model.matrix(~ 0 + factor(c(0, 0, 0, 0, 1, 1, 1, 1))) # 0=Vehicle; 1=Drug
  colnames(design) <- c("V", "D") # 0=Vehicle; 1=Drug
  
  data.DIA <- grep("_", colnames(data))
  data[, data.DIA] <- log((data[, data.DIA]), base = 2)
  data.metanms <- grep("Stripped.Sequence", colnames(data))
  data$last <- (regexpr(';', as.character(data$Protein.Ids)) - 1) # if no ";" then = -1
  data$UID <- ifelse(data$last > 0, (substr(as.character(data$Protein.Ids), 1, data$last)),
                     (as.character(data$Protein.Ids)))
  data$last <- NULL
  intensity <- grep("_", colnames(data))
  data <- setNames(data, columnnames)
  data$ID <- 1:nrow(data)
  
  fit <- lmFit(data[, intensity], design)
  fit <- eBayes(fit) ## Apply empirical Bayes smoothing to the standard errors.
  contrast <- makeContrasts("D-V", levels = design)
  fit2 <- contrasts.fit(fit, contrast)
  fit2 <- eBayes(fit2, trend = TRUE)
  
  ptopf <- topTableF(fit2, adjust = "BH", genelist = data[, c("ID")], number = Inf)
  ptopf$rank <- 1:length(ptopf$F)
  ptopf$numfp <- ptopf$rank * ptopf$adj.P.Val
  
  t.stat <- topTable(fit2, adjust = "BH", genelist = data[, "ID"], coef = 1, p.value = 1, number = Inf)
  nms <- grep("logFC", colnames(t.stat)) 
  colnames(t.stat)[nms] <- "Log2FC"
  t.stat$Log10P.Value <- -log(t.stat$P.Value, base = 10)
  t.stat$Log10adj.P.Val <- -log(t.stat$adj.P.Val, base = 10)
  t.statNMS <- t.stat[c("ID", "Log2FC", "Log10P.Value", "Log10adj.P.Val", "P.Value", "adj.P.Val", "AveExpr", "t", "B")]
  t.stat <- t.statNMS
  
  data.analysis <- merge(t.stat, data, by = "ID", all = TRUE, sort = FALSE)
  
  
  # step-3：annotation known binding
  kinase <- read.csv("kinase_hub.csv", header = TRUE)
  contam <- read.csv("contamination_protein.csv", header = TRUE)
  
  data.analysis <- data.analysis %>%
    mutate(is.kinase = ifelse(UID %in% kinase$UniprotID,"yes","no")) %>%
    mutate(is.contam = ifelse(UID %in% contam$UID,"yes","no")) %>%
    filter(is.contam=="no")
  
  # Export the results
  write.csv(data.analysis, file = paste0("bayes_test_peptides_",dataset_name,".csv"))
  
  
}



datasets <- list(
  crude = renamed_crude,
  cleared = renamed_cleared)

library(purrr)
map2(datasets, names(datasets), ~ analyze_data(.x, .y))


```



# 5. Plotting 


## 5.1 Fig3B and 3C: Volcano plots showing the dasatinib target identification in the cleared and crude lysates

```{r}

trans_membrane <- read.csv("human_subcellular_location.csv", header=T) %>%
  filter(Transmembrane != "")

crude_protein <- read.csv("bayes_test_peptides_crude.csv",header = T)%>%
  distinct(UID, .keep_all = TRUE) %>%
  arrange(is.kinase) %>% 
  mutate(is.trans.membrane = ifelse(UID %in% trans_membrane$Entry,"yes","no"))

cleared_protein <- read.csv("bayes_test_peptides_cleared.csv",header = T)%>%
  distinct(UID, .keep_all = TRUE) %>%
  arrange(is.kinase) %>% 
  mutate(is.trans.membrane = ifelse(UID %in% trans_membrane$Entry,"yes","no"))


crude_target <- crude_protein %>% 
  filter(Log10P.Value > 4)

cleared_target <- cleared_protein %>% 
  filter(Log10P.Value > 4)

overlapped <- intersect(crude_target$UID, cleared_target$UID)
cleared_only <- setdiff(cleared_target$UID, crude_target$UID)
crude_only <- setdiff(crude_target$UID, cleared_target$UID)


crude_protein <- crude_protein %>% 
  mutate(is.unique.target = ifelse(UID %in% crude_only ,"yes","no"))
           
cleared_protein <- cleared_protein %>% 
  mutate(is.unique.target = ifelse(UID %in% cleared_only ,"yes","no"))


## run this line for generation of Fig 3B
protein <- cleared_protein

p <- ggplot(data = protein, aes(x = Log2FC, y = Log10P.Value, fill = is.kinase))  +
  geom_point(shape = 21,color = "black", size = 2, alpha = 0.7,stroke= 0.2)+  
  scale_fill_manual(name= "is.kinase",breaks = c("yes","no"), values = c("#E69F00","#b3b3b3"))+
  geom_text_repel(
    data = subset(protein, Log10P.Value >4),
    aes(label = Genes,
         color = is.unique.target),
    size = 3, 
    box.padding = unit(0.1, "lines"), 
    point.padding = unit(0.3, "lines"),  
    segment.color = "grey50", 
    show.legend = FALSE,
    max.overlaps = 20
  ) + scale_x_continuous(
    name = expression(Log["2"] * FC),
    limits = c(-3, 3),
    breaks = -3:3
  )+
  scale_color_manual(name = "unique_membrane_kinases",breaks = c("yes","no"), values = c("#d8303f","black"))+
  scale_y_continuous(
    name = expression(-Log["10"] * Pvalue),
    limits = c(0, 13),
    breaks = seq(0, 12, by = 2)
  ) +
  labs(
    title = "cleared lysates with Dasatinib"
  ) +
  annotate(
    "text", 
    x = 0, y = 13, 
    label = paste0("Protein number = ", nrow(protein)), 
    size = 5,  
    hjust = 0.5, 
    vjust = 1.5,  
    color = "black"
  )+mytheme
p

## when run "protein <- cleared_protein"
ggsave(paste0("Fig.3B",".pdf"),width = 6,height = 5.5,useDingbats=FALSE)



## run this line for generation of Fig 3C
protein <- crude_protein

p <- ggplot(data = protein, aes(x = Log2FC, y = Log10P.Value, fill = is.kinase))  +
  geom_point(shape = 21,color = "black", size = 2, alpha = 0.7,stroke= 0.2)+  
  scale_fill_manual(name= "is.kinase",breaks = c("yes","no"), values = c("#E69F00","#b3b3b3"))+
  geom_text_repel(
    data = subset(protein, Log10P.Value >4),
    aes(label = Genes,
         color = is.unique.target),
    size = 3, 
    box.padding = unit(0.1, "lines"), 
    point.padding = unit(0.3, "lines"),  
    segment.color = "grey50", 
    show.legend = FALSE,
    max.overlaps = 20
  ) + scale_x_continuous(
    name = expression(Log["2"] * FC),
    limits = c(-3, 3),
    breaks = -3:3
  )+
  scale_color_manual(name = "unique_membrane_kinases",breaks = c("yes","no"), values = c("#d8303f","black"))+
  scale_y_continuous(
    name = expression(-Log["10"] * Pvalue),
    limits = c(0, 13),
    breaks = seq(0, 12, by = 2)
  ) +
  labs(
    title = "crude lysates with Dasatinib"
  ) +
  annotate(
    "text", 
    x = 0, y = 13, 
    label = paste0("Protein number = ", nrow(protein)), 
    size = 5,  
    hjust = 0.5, 
    vjust = 1.5,  
    color = "black"
  )+mytheme
p


## when run "protein <- crude_protein"
ggsave(paste0("Fig.3C",".pdf"),width = 6,height = 5.5,useDingbats=FALSE)

```


## 5.2 Fig.S3A: GO CC analysis of the proteins that are uniquely identified in the crude lysates

```{r}

crude_protein <- crude_protein %>%
  mutate(in.cleared= ifelse(UID %in% cleared_protein$UID,"yes","no"))


table(crude_protein$in.supernatant)

crude_unique_proteins <- crude_protein %>%
  filter(in.cleared =="no")


library(clusterProfiler)
library(DOSE)
library(org.Hs.eg.db)






ego <- enrichGO(gene          = crude_unique_proteins$UID,
                OrgDb         = org.Hs.eg.db,
                universe = crude_protein$UID,
                keyType = "UNIPROT",
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05,
                readable      = TRUE)

str(ego)

go_cc <- ego@result %>%
  arrange(p.adjust) %>%
  head(15) %>%
  mutate(
    Description = factor(Description, levels = Description[order(-log10(p.adjust))]) 
  )

colnames(go_cc)

p <- ggplot(go_cc,aes(x= -log10(p.adjust),y= Description))+geom_point(
  aes(color= Count),size = 5)+
  scale_color_gradient(
    low = "#d1e9d2", 
    high = "#366438")+
  theme_minimal() +  # 使用简洁的主题
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5), 
    axis.title = element_text(size = 10), 
    axis.text = element_text(size = 10,color="black"), 
    legend.title = element_text(size = 10),  
    legend.text = element_text(size = 10),  
    panel.grid.major = element_line(color = "grey80", linewidth = 0.3), 
    panel.grid.minor = element_blank(), 
    panel.background = element_rect(fill = "white", color = "black", linewidth = 0.7),  
    plot.background = element_rect(fill = "white",colour = NA),axis.ticks = element_line(color = "black", linewidth = 0.3),  
    axis.ticks.length = unit(0.2, "cm") 
  )

p

ggsave(paste0("Fig.S3A",".pdf"),width = 8,height = 5.5,useDingbats=FALSE)

```


## 5.3 Fig.S3B and S3C: Barplot and pie charts to compare the dasatinib targets identified in the crude and cleared lysates

```{r}

count_kinase <- rbind(crude_target, cleared_target) %>%
  distinct(UID,.keep_all = TRUE) %>% 
  mutate(
    source = factor(
      ifelse(UID %in% overlapped, "overlapped",
             ifelse(UID %in% cleared_only, "cleared_unique", "crude_unique")),
      levels = c("overlapped", "crude_unique", "cleared_unique") 
    ))%>%
  group_by(source,is.kinase) %>%
  count()
  


data_plot <- count_kinase

p <- ggplot(data=data_plot)+
  geom_bar(aes(x=source,y=n,fill=is.kinase),stat = "identity",width = 0.4)+
  scale_y_continuous("protein number",breaks = c(0,10,20,30,40,45),limits = c(0,45))+
  scale_x_discrete(expand=c(0.1,0.1))+
scale_fill_manual(name="is.kinases",breaks=c("yes","no"),values = c("#a995c4","gray75"))+
  theme_classic()+
  annotate(x=rep(c("overlapped", "crude_unique","cleared_unique"),times=2),y=c(15,5,3,38,12,6),label=c("36","8","5","7","9","3"),geom = "text",size=2)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size=5,color="black",margin = margin(2,0,-4.5,0)),
        axis.title.y = element_text(size = 6,margin = margin(0,0,0,-3)),
        axis.text.y = element_text(size = 5,colour = "black",margin = margin(0,0.8,0,0)),
        legend.position = "right",
        legend.title = element_text(size = 5),
        legend.key.size = unit(5,"points"),legend.spacing.x = unit(0.05,"cm"),legend.text = element_text(size = 5),legend.background = element_blank(),
        axis.ticks = element_line(size = 0.2,color = "black"),
        axis.ticks.length = unit(0.05,"cm"),
        axis.line = element_line(size=0.2))

p
ggsave("FigS3B.pdf",p,width =6.5,height = 6,units = "cm")


## Fig.S3C

count_membrane <- rbind(crude_target, cleared_target) %>%
  distinct(UID,.keep_all = TRUE) %>% 
  mutate(
    source = factor(
      ifelse(UID %in% overlapped, "overlapped",
             ifelse(UID %in% cleared_only, "cleared_unique", "crude_unique")),
      levels = c("overlapped", "crude_unique", "cleared_unique") 
    ))%>%
  group_by(source,is.trans.membrane) %>%
  count()

overlapped <- count_membrane %>%
  filter(source=="overlapped")

crude_unique <- count_membrane %>%
  filter(source=="crude_unique")
  
pie(overlapped$n,
    labels = "is.trans.membrane", 
    main = "Fig.S3C_overlapped") 

pie(crude_unique$n,
    labels = "is.trans.membrane", 
    main = "Fig.S3C_crude_unique")

```

